---
const {
  cell = 64,          // px grid size
  majorEvery = 4,     // every Nth line is "Major"
  
  // Opacity settings
  lineOpacity = 0.2,  // Max opacity of minor lines (at cursor)
  majorOpacity = 0.3, // Max opacity of major lines (at cursor)
  
  // Spotlight settings
  spotlightRadius = 200,
  minOpacity = 0.15   // How visible the grid is *away* from the cursor (0 to 1)
} = Astro.props;

// Calculate the repeat size for the major grid
const majorSize = cell * majorEvery;

const cssVars = {
  '--cell': `${cell}px`,
  '--major-size': `${majorSize}px`,
  '--lineOpacity': lineOpacity,
  '--majorOpacity': majorOpacity,
  '--spotlight-r': `${spotlightRadius}px`,
  '--minOpacity': minOpacity,
};
---

<div class="grid-wrap" aria-hidden="true" style={cssVars} transition:persist>
  <div class="grid" id="grid-layer"></div>
</div>

<style>
  .grid-wrap {
    position: fixed;
    inset: 0;
    z-index: -1;
    pointer-events: none;
    overflow: hidden;
  }

  .grid {
    position: absolute;
    inset: 0;
    transform: translateZ(0); /* Hardware acceleration */
    
    /* 1. Theme-aware base color (Black in light, White in dark) */
    --grid-rgb: 0, 0, 0;

    /* 2. The Grid Pattern */
    background-image:
      /* Minor Grid */
      linear-gradient(to right, rgba(var(--grid-rgb), var(--lineOpacity)) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(var(--grid-rgb), var(--lineOpacity)) 1px, transparent 1px),
      /* Major Grid */
      linear-gradient(to right, rgba(var(--grid-rgb), var(--majorOpacity)) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(var(--grid-rgb), var(--majorOpacity)) 1px, transparent 1px);

    background-size:
      var(--cell) var(--cell),
      var(--cell) var(--cell),
      var(--major-size) var(--major-size),
      var(--major-size) var(--major-size);

    /* 3. The Spotlight Mask 
       We use a radial gradient that moves based on --x and --y.
       - Center: opaque (shows the grid fully)
       - Edge: minOpacity (fades grid out)
    */
    mask-image: radial-gradient(
      circle var(--spotlight-r) at var(--x, 50%) var(--y, 50%), 
      black 0%, 
      rgba(0,0,0, var(--minOpacity)) 100%
    );
    
    /* Webkit prefix for better browser support (Chrome/Safari) */
    -webkit-mask-image: radial-gradient(
      circle var(--spotlight-r) at var(--x, 50%) var(--y, 50%), 
      black 0%, 
      rgba(0,0,0, var(--minOpacity)) 100%
    );
  }

  /* Dark mode override */
  :global(.darkmode) .grid {
    --grid-rgb: 255, 255, 255;
  }
</style>

<script>
  // Script to update the spotlight position
  const grid = document.getElementById('grid-layer');
  
  // Check for reduced motion preference
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (grid && !prefersReducedMotion) {
    let ticking = false;

    const updateGradient = (x, y) => {
      grid.style.setProperty('--x', `${x}px`);
      grid.style.setProperty('--y', `${y}px`);
      ticking = false;
    };

    const onMove = (e) => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateGradient(e.clientX, e.clientY);
        });
        ticking = true;
      }
    };

    // Track mouse
    document.addEventListener('mousemove', onMove);
    
    // Track touch
    document.addEventListener('touchmove', (e) => {
        if(e.touches.length > 0) {
            onMove(e.touches[0]);
        }
    }, { passive: true });
  }
</script>